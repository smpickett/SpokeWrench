<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Ride Tracking</title>

<link rel="stylesheet" type="text/css" href="RideTracking.css">

<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript">
  var selected_rows = new Array()

  $(document).ready(function(){
      dataTable_PerformShading();

    $('tr.Equipbike').toggle(this.checked);
    $('tr.DataHrMonitor').toggle(this.checked);
    $('tr.DataSpeedometer').toggle(this.checked);
  
    $('#equipbike').click(function() {
      $('tr.Equipbike').toggle(this.checked);
    });
    $('#dataHrMonitor').click(function() {
      $('tr.DataHrMonitor').toggle(this.checked);
    });
    $('#dataSpeedometer').click(function() { 
      $('tr.DataSpeedometer').toggle(this.checked);
    });

    $('table.tabledata tr').click(function()
    {
      ToggleRowSelection($(this));
    });
  });

  function ToggleRowSelection(row)
  {
    if($(row).attr('id') == 'rowHeader')
      return;

    if($(row).hasClass("table.tabledata selected"))
    {
      $(row).removeClass("table.tabledata selected");
      for (i = 0; i < selected_rows.length; i++)
        if(selected_rows[i] == row[0].rowIndex)
          selected_rows.splice(i, 1);
    }
    else
    {
      $(row).addClass("table.tabledata selected");
      selected_rows.push(parseInt(row[0].rowIndex));
    }
  }


  var EditSelectedRideId = 0;
  function EditSelectedRide()
  {
    if(selected_rows.length == 0)
      alert("Please select ride to edit");
    else
    {
      var row = selected_rows[0];
      EditSelectedRideId = RideIdentityFromRow(row);
      $('input#date').val(document.getElementById('tableDataMain').rows[row].cells[2].innerHTML);
      $('input#time').val(document.getElementById('tableDataMain').rows[row].cells[3].innerHTML);
      $('input#route').val(document.getElementById('tableDataMain').rows[row].cells[4].innerHTML);
      $('select#type').val(document.getElementById('tableDataMain').rows[row].cells[5].innerHTML);
      $('input#SPD_time').val(document.getElementById('tableDataMain').rows[row].cells[6].innerHTML);
      $('input#SPD_dist').val(document.getElementById('tableDataMain').rows[row].cells[7].innerHTML);
      $('input#SPD_avecad').val(document.getElementById('tableDataMain').rows[row].cells[8].innerHTML);
      $('input#HRM_time').val(document.getElementById('tableDataMain').rows[row].cells[9].innerHTML);
      $('input#HRM_cals').val(document.getElementById('tableDataMain').rows[row].cells[10].innerHTML);
      $('input#HRM_avehr').val(document.getElementById('tableDataMain').rows[row].cells[11].innerHTML);
      $('input#HRM_maxhr').val(document.getElementById('tableDataMain').rows[row].cells[12].innerHTML);
      $('input#AddEditRideButton').val('Save');
      $('input#AddEditRideButton').removeAttr('onClick');
      $('input#AddEditRideButton').unbind('click');
      $('input#AddEditRideButton').bind('click', function(){Submit_EditRide(EditSelectedRideId);});
      $('th#AddEditRideTitle').text("Edit Ride");
    }
    return false;
  }




  function DeleteRows()
  { 
    if(selected_rows.length == 0)
      alert("Please select ride(s) to delete");
    else
    {
      $yes = confirm("Are you sure you want to delete the selected rides?");

      if($yes)
      {
        selected_rows.sort(sortNumber);
        do
        {
          var row = selected_rows.pop();
          /* Call the PHP Delete function */
          $.ajax({
                type:'POST',
                url: 'DeleteRide.php',
                data: 'id='+RideIdentityFromRow(row)
  //              success: function(data){ alert("OK"); },
 //               error: function(data){ alert("Error"); },
//                complete: function(data){ alert("Done"); }
                });
          
          /* Hide, remove from row selection  */
          HideSelectedRow(row);
        }
        while (selected_rows.length != 0)

        dataTable_PerformShading();
      }
    }
    
    return false;
  }

  function CopyRows()
  {
    if(selected_rows.length == 0)
      alert("Please select ride(s) to copy");
    else
    {
      selected_rows.sort(sortNumber);
      do
      {
        var row = selected_rows.pop();
          $.ajax({
                type:'POST',
                url: 'CopyRide.php',
                data: { id: RideIdentityFromRow(row), row: row },
                dataType : 'json',
                success: function(data)
                {
                  var oldRow = document.getElementById('tableDataMain').rows[data.row];
                  var blankRow = document.getElementById('tableDataMain').insertRow(parseInt(data.row)+1);
                  var newRow = oldRow.cloneNode(true);
                  document.getElementById('tableDataMain').appendChild(newRow);
                    document.getElementById('tableDataMain').firstChild.replaceChild(newRow, blankRow);

                  var newRowChildren = $(newRow).children("td");
                  for(var i=0; i<newRowChildren.length; i++)
                    newRowChildren[i].style.display = 'none';

                  newRow.cells(0).innerHTML = data.dataID;
                  ShowHideTableRow(newRow, true, function(){dataTable_PerformShading();});
                  newRow.onclick = function(){ToggleRowSelection($(this))};

//                  $(newRow).removeClass("table.tabledata selected");
//                  $(oldRow).removeClass("table.tabledata selected");
                }
//                error: function(data){ alert("Error"); },
//                complete: function(jqXHR, textStatus)
//                  {
//                    alert("Complete:"+textStatus);
//                  }
          });
      }
      while (selected_rows.length != 0)

      $('#tableDataMain tr').removeClass("table.tabledata selected");
    }
    return false;
  }

  function RefreshTable()
  {
    if (window.XMLHttpRequest)
      {// code for IE7+, Firefox, Chrome, Opera, Safari
      xmlhttp=new XMLHttpRequest();
      }
    else
      {// code for IE6, IE5
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
      }
    xmlhttp.onreadystatechange=function()
    {
      if (xmlhttp.readyState==4 && xmlhttp.status==200)
      {
        // Remove the old table
        var child = document.getElementById("tableDataMain");
        if(child != null)
          child.parentNode.removeChild(child);

        // Create a new table and tie it to a variable
        var newcontent = document.createElement('div');
        newcontent.innerHTML = xmlhttp.responseText;

        // Add the new table to the HTML page
        document.getElementById("div_tableData").appendChild(newcontent);
        $('table.tabledata tr').click(function() {ToggleRowSelection($(this));});
        dataTable_PerformShading();
      }
    }
    xmlhttp.open("GET","DrawTable.php",true);
    xmlhttp.send();
  
    return false;
  }

  function HideSelectedRow(rowNum)
  {
    ShowHideTableRow(document.getElementById('tableDataMain').rows[rowNum], false, function(){dataTable_DeleteRow(rowNum);});
  }

  function RideIdentityFromRow(rowNum)
  {
    return document.getElementById('tableDataMain').rows[rowNum].cells[0].innerHTML;
  }

  function sortNumber(a,b)
  {
    return a - b;
  }

  function dataTable_PerformShading()
  {
    $('#tableDataMain tr:even').addClass('alt');
    $('#tableDataMain tr:odd').removeClass('alt');
  }

  function dataTable_DeleteRow(rowNum)
  {
    document.getElementById('tableDataMain').deleteRow(rowNum);
    dataTable_PerformShading();
  }

  function sortColumns(a, b)
  {
    return a.cellIndex - b.cellIndex
  }


function ShowHideTableRow(rowSelector, show, callback)
{
    var childCellsSelector = $(rowSelector).children("td");
    var ubound = childCellsSelector.length - 1;
    var lastCallback = null;

    //childCellsSelector.sort(sortColumns); /* for some reason this is screwing up the callback... */ /* also, didnt fix the issue */
    childCellsSelector.each(function(i)
    {
        // Only execute the callback on the last element.
        if (ubound == i)
          lastCallback = callback;

        if(show && !$(this).hasClass('hidden'))
          $(this).fadeIn(500, lastCallback);
        else if(!show)
        $(this).fadeOut(500, lastCallback);
    });
}

</script>


<script type="text/javascript">
function AddRide(show)
{
  if(show && !AddRide.Shown)
  {
    var newCell=$('#MainRow')[0].insertCell(1);
    newCell.innerHTML = "Test";
    $(newCell).css('width','400px');
    AddRide.Shown = true;
  }
  else if(!show)
  {
    $('#MainRow')[0].removeCell(1);
  }
}

function AED_ToggleRow(checkbox)
{
  var rowId = "#" + checkbox.id + "_row";
  if(checkbox.checked)
    $(rowId).removeClass('dataEntryHidden');
  else
    $(rowId).addClass('dataEntryHidden');
}




</script>

</head>





<body>
  <div class="div_dataTable" id="div_tableData">
    <table class="icons" id="table_icons">
    <tr>
    <td><form onSubmit="return RefreshTable();"><input type="image" src="../resources/web-orange-buttons-by-axialis-team/ico/Refresh.ico" width="18" height="18" /></form></td>
    <td><form onSubmit="return EditSelectedRide();"><input type="image" src="../resources/web-orange-buttons-by-axialis-team/ico/Write3.ico" width="18" height="18" /></td>
    <td><form onSubmit="return CopyRows();"><input type="image" src="../resources/web-orange-buttons-by-axialis-team/ico/Clipboard Copy.ico" width="18" height="18" /></form></td>
    <td><form onSubmit="return DeleteRows();"><input type="image" src="../resources/web-orange-buttons-by-axialis-team/ico/Cancel.ico" width="18" height="18" /></form></td>
    <td></td>
    <td><form onSubmit="return SaveCSV();"><input type="image" src="../resources/web-orange-buttons-by-axialis-team/ico/Save.ico" width="18" height="18" /></form></td>
    </tr>
    </table>
    <?php include('DrawTable.php'); ?>
  </div>

  <div class="div_addData">
    <script type='text/javascript'>
    function Submit_EditRide(rideId)
    {
      alert(rideId);
      $('input#AddEditRideButton').val('Add');
      $('input#AddEditRideButton').unbind('click');
      $('input#AddEditRideButton').bind('click', function(){Submit_AddRide();});
      $('th#AddEditRideTitle').text("Add Ride");
    }

    function Submit_AddRide()
    {
      if($('input#date').val() == "")
      {
        alert("Please enter a date");
        return false;
      }

      $.ajax({
        type: "POST",
        dataType : 'json',
        url: "AddRide.php",
        data: {
                date: $('input#date').val(),
                time: $('input#time').val(),
                route: $('input#route').val(),
                category: $('select#type').val(),
                DataSpeedometer_cadence: $('input#SPD_avecad').val(),
                DataSpeedometer_time: $('input#SPD_time').val(),
                DataSpeedometer_dist: $('input#SPD_dist').val(),
                DataHrMonitor_avehr: $('input#HRM_avehr').val(),
                DataHrMonitor_maxhr: $('input#HRM_avehr').val(),
                DataHrMonitor_time: $('input#HRM_time').val(),
                DataHrMonitor_calories: $('input#HRM_cals').val(),
              },
        success: function(data){RefreshTable();/*alert(data.msg);*/},
        error: function(data){alert(data.responseText);}
        });

      return false;
    }
    </script>
    <?php include('DrawAddRideTable.php'); ?>
  </div>
<br>






<br>


</body>


</html>
